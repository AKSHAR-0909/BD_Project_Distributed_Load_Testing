<!-- templates/test_configure.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Configuration</title>
    <link rel="stylesheet" href="../static/styles/index.css">
</head>
<body>
    <!--{% if error %}
        <p style="color: red;">{{ error }}</p>
    {% endif %}
    {% if message %}
        <p style="color: green;">{{ message }}</p>
    {% endif %}-->
    <div class="grid-container">
        <div class="config-container">
            <h1>Test Configurations</h1>
            <form action="/test_configure" method="post" id="test-form">
                <label for="test_type">Test Type:</label>
                <select id="test_type" name="test_type" required>
                    <option value="tsunami">Tsunami</option>
                    <option value="avalanche">Avalanche</option>
                </select><br>
                <label for="test_message_delay">Test Message Delay:</label>
                <input type="text" id="test_message_delay" name="test_message_delay" required><br>
                <label for="request_per_driver">Number of requests:</label>
                <input type="number" id="request_per_driver" name="request_per_driver" required><br>
                <button type="submit">Done</button>
            </form>
            <form action="/trigger_test" method="get" id="trigger-form">
                <button type="submit" id="trigger-button" >Trigger Test</button>
            </form>
        </div>
        <div class="metrics-container">
            <h1>Metrics and Heartbeats</h1>
            <table>
                <thead>
                    <tr>
                        <th>Node ID</th>
                        <th>Heartbeat</th>
                    </tr>
                </thead>
                <tbody id="heartbeat_body"></tbody>        
            </table>
            <table>
                <thead>
                    <tr>
                        <th>node_id</th>
                        <th>num_requests</th>
                        <th>mean_latency</th> 
                        <th> median_latency</th> 
                        <th>min_latency</th>  
                        <th>max_latency</th>
                    </tr>
                </thead>
                <tbody id="metric_body"></tbody>        
            </table>
        </div>
    </div>

    <!-- <ul id="kafka-messages"></ul> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
    <!-- ... (previous HTML code) ... -->

<script>
    var socket = io.connect('http://' + document.domain + ':' + location.port);
    var isTestRunning = false; // Variable to track the test status

    // Function to disable the button and prevent multiple clicks
    function triggerTest() {
        var triggerButton = document.getElementById('trigger-button');

        // Check if the test is already running
        if (isTestRunning) {
            alert("Test is already running. Please wait for it to complete.");
            return;
        }

        triggerButton.disabled = true;
        isTestRunning = true;

        // Simulate the test duration (replace this with your actual test logic)
        setTimeout(function () {
            // Re-enable the button after the test is complete
            triggerButton.disabled = false;
            isTestRunning = false;
        }, 5000);
    }

    // Event listener for receiving Kafka heartbeat messages
    socket.on('update_server_heartbeats', function (heartbeats) {
        var heartbeatBody = document.getElementById('heartbeat_body');
        heartbeatBody.innerHTML = ''; // Clear existing entries

        // Iterate through the heartbeats and add rows to the table
        for (var nodeId in heartbeats) {
            var heartbeat = heartbeats[nodeId];
            var row = heartbeatBody.insertRow();
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            cell1.innerHTML = nodeId;
            cell2.innerHTML = heartbeat;
        }
    });

    socket.on('metric_update', function (json_metric) {
    var metricBody = document.getElementById('metric_body');
    // metricBody.innerHTML = ''; // Clear existing entries
    console.log("here", json_metric);

    var node_id = json_metric['node_id'];
    var num_requests = json_metric['num_requests'];
    var mean_latency = json_metric['metrics']['mean_latency'];
    var median_latency = json_metric['metrics']['median_latency'];
    var min_latency = json_metric['metrics']['min_latency'];
    var max_latency = json_metric['metrics']['max_latency'];

    var row = metricBody.insertRow(); // Changed from 'heartbeatBody' to 'metricBody'

    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);
    var cell5 = row.insertCell(4);
    var cell6 = row.insertCell(5);

    cell1.innerHTML = node_id;
    cell2.innerHTML = num_requests;
    cell3.innerHTML = mean_latency;
    cell4.innerHTML = median_latency;
    cell5.innerHTML = min_latency;
    cell6.innerHTML = max_latency;

    metricBody.appendChild(row);
});

</script>
</body>
</html>

</body>
</html>


